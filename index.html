<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Assistant Message IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-gradient: radial-gradient(circle at top, #1d4ed8 0, #020617 55%);
        --card-bg: rgba(15, 23, 42, 0.9);
        --border-subtle: rgba(148, 163, 184, 0.35);
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.12);
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg-gradient);
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .shell {
        width: 100%;
        max-width: 760px;
      }

      .logo-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        justify-content: center;
      }

      .logo-dot {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #ffffff 0, #3b82f6 40%, #1d4ed8 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
        color: #e5e7eb;
      }

      .headline {
        text-align: center;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .subtitle {
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 18px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border-subtle);
        box-shadow: 0 22px 60px rgba(15, 23, 42, 0.8);
        padding: 18px 18px 16px;
        backdrop-filter: blur(18px);
      }

      label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 4px;
      }

      .pill {
        font-size: 0.7rem;
        border-radius: 999px;
        padding: 2px 7px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: var(--text-muted);
      }

      textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        padding: 8px 10px;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 100px;
        outline: none;
      }

      textarea::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      .chips-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }

      .chip {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        padding: 4px 10px;
        font-size: 0.78rem;
        color: var(--text-muted);
        cursor: pointer;
        user-select: none;
      }

      .chip.active {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: #bfdbfe;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 12px 0 6px;
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 9px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          background 0.15s ease;
      }

      button.primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: #e5e7eb;
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
        width: 100%;
        justify-content: center;
      }

      button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 38px rgba(37, 99, 235, 0.55);
      }

      button.secondary {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-muted);
        border: 1px solid rgba(148, 163, 184, 0.5);
      }

      button:disabled {
        opacity: 0.6;
        transform: none;
        box-shadow: none;
        cursor: default;
      }

      .status-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
      }

      .status {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .status.error {
        color: #fca5a5;
      }

      .hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
      }

      @media (max-width: 600px) {
        .card {
          padding: 14px 14px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="logo-row">
        <div class="logo-dot">IA</div>
        <div class="headline">Assistant Message IA</div>
      </div>
      <div class="subtitle">
        Tu √©cris ton id√©e, il sort un mail propre. Utilisable sur PC et mobile.
      </div>

      <div class="card">
        <label>
          Signature
          <span class="pill">Ajout√©e automatiquement</span>
        </label>
        <textarea
          id="signature"
          rows="2"
          placeholder="Cordialement,&#10;Mourad Afekhssi"
        ></textarea>
        <div class="hint">
          Elle sera ajout√©e √† la fin de chaque mail g√©n√©r√©.
        </div>

        <label style="margin-top: 12px">
          Message rapide
          <span class="pill">Brouillon libre</span>
        </label>
        <textarea
          id="inputText"
          placeholder="Ex : dire que je suis surpris par le retard, demander un retour avant demain, rester poli mais ferme‚Ä¶"
        ></textarea>

        <label style="margin-top: 10px">
          Ton du mail
          <span class="pill">Ajuste la forme, pas le fond</span>
        </label>

        <div class="chips-row" id="toneChips">
          <div class="chip active" data-tone="professionnel">Professionnel</div>
          <div class="chip" data-tone="amical">Amical</div>
          <div class="chip" data-tone="concis">Tr√®s concis</div>
          <div class="chip" data-tone="ferme">Ferme / poli</div>
          <div class="chip" data-tone="excuse">Excuse</div>
          <div class="chip" data-tone="relance">Relance</div>
          <div class="chip" data-tone="remerciement">Remerciement</div>
        </div>

        <div class="actions">
          <button class="primary" id="generateBtn">
            ‚úâÔ∏è G√©n√©rer le mail
          </button>
        </div>

        <label style="margin-top: 8px">
          Mail g√©n√©r√©
          <span class="pill">Editable avant envoi</span>
        </label>
        <textarea
          id="outputText"
          rows="7"
          placeholder="Le mail final appara√Ætra ici..."
        ></textarea>

        <div class="status-row">
          <div id="status" class="status"></div>
          <button class="secondary" id="copyBtn">üìã Copier</button>
        </div>
      </div>
    </div>

    <script>
      // üëâ URL de TON worker ‚Äì bien celle-ci :
      const WORKER_URL =
        "https://assistant-message-ia.mourad-afekhssi.workers.dev/";

      console.log("Script charg√©, WORKER_URL =", WORKER_URL);

      const signatureInput = document.getElementById("signature");
      const inputText = document.getElementById("inputText");
      const outputText = document.getElementById("outputText");
      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const statusBox = document.getElementById("status");
      const toneChips = document.getElementById("toneChips");

      let currentTone = "professionnel";

      // Stocker la signature en localStorage
      window.addEventListener("load", () => {
        console.log("DOM charg√©");
        const savedSig = localStorage.getItem("assistant_signature");
        if (savedSig) signatureInput.value = savedSig;
        else signatureInput.value = "Cordialement,\nMourad Afekhssi";
      });

      signatureInput.addEventListener("change", () => {
        localStorage.setItem("assistant_signature", signatureInput.value.trim());
      });

      // S√©lection du ton
      toneChips.addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        [...toneChips.querySelectorAll(".chip")].forEach((c) =>
          c.classList.remove("active")
        );
        chip.classList.add("active");
        currentTone = chip.dataset.tone;
      });

      async function generateMail() {
        console.log("Bouton g√©n√©rer cliqu√©");
        statusBox.classList.remove("error");
        statusBox.textContent = "";

        const notes = inputText.value.trim();
        const signature = signatureInput.value.trim();

        if (!notes) {
          statusBox.textContent = "Ajoute d'abord quelques phrases de brouillon.";
          statusBox.classList.add("error");
          return;
        }

        generateBtn.disabled = true;
        generateBtn.textContent = "G√©n√©ration‚Ä¶";
        statusBox.textContent = "Je r√©dige ton mail‚Ä¶";

        const body = { notes, tone: currentTone, signature };
        console.log("Body envoy√© au worker :", body);

        try {
          const res = await fetch(WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          console.log("R√©ponse brute du worker :", res.status, res.statusText);

          const data = await res.json().catch((e) => {
            console.error("Erreur parse JSON:", e);
            throw e;
          });

          console.log("JSON re√ßu :", data);

          if (!res.ok) {
            statusBox.textContent =
              "Erreur c√¥t√© worker : " + (data.error || "");
            statusBox.classList.add("error");
            return;
          }

          outputText.value = data.mail || "";
          statusBox.textContent =
            "Mail g√©n√©r√©. Relis puis colle-le dans ton client mail.";
        } catch (e) {
          console.error("Erreur globale :", e);
          statusBox.textContent = "Erreur JS : " + e.message;
          statusBox.classList.add("error");
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = "‚úâÔ∏è G√©n√©rer le mail";
        }
      }

      generateBtn.addEventListener("click", generateMail);

      copyBtn.addEventListener("click", async () => {
        const txt = outputText.value.trim();
        statusBox.classList.remove("error");

        if (!txt) {
          statusBox.textContent = "Rien √† copier pour l'instant.";
          statusBox.classList.add("error");
          return;
        }

        try {
          await navigator.clipboard.writeText(txt);
          statusBox.textContent =
            "Mail copi√©. Colle-le dans FastMail / Proton / Spark.";
        } catch {
          statusBox.textContent =
            "Impossible de copier automatiquement. S√©lectionne le texte √† la main.";
          statusBox.classList.add("error");
        }
      });
    </script>
  </body>
</html>
